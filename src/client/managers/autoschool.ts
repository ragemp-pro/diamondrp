import { methods } from "../modules/methods";
import { wait } from "../../util/methods";
import { seatBelt } from "../modules/events";

export {}

interface point {
  x:number;
  y:number;
  z:number;
  h:number;
}

let checkPointsVeh:point[] = [{"x":-749.3578491210938,"y":-1288.264404296875,"z":4.588924407958984,"h":302.64276123046875},{"x":-685.7508544921875,"y":-1253.7322998046875,"z":10.083617210388184,"h":212.77566528320312},{"x":-656.7947387695312,"y":-1326.065673828125,"z":10.040692329406738,"h":194.47869873046875},{"x":-662.9129638671875,"y":-1493.6549072265625,"z":10.238850593566895,"h":173.14862060546875},{"x":-744.84228515625,"y":-1614.1146240234375,"z":23.970813751220703,"h":136.8641357421875},{"x":-768.5723876953125,"y":-1732.2086181640625,"z":28.741559982299805,"h":184.89529418945312},{"x":-723.853759765625,"y":-1874.55126953125,"z":26.775035858154297,"h":211.02972412109375},{"x":-121.97946166992188,"y":-2090.040771484375,"z":25.006683349609375,"h":288.79815673828125},{"x":166.97406005859375,"y":-2016.370361328125,"z":17.66499137878418,"h":337.7317810058594},{"x":187.1753387451172,"y":-1898.2216796875,"z":23.1441593170166,"h":64.40127563476562},{"x":113.22127532958984,"y":-1845.48388671875,"z":24.97246551513672,"h":318.924072265625},{"x":154.04776000976562,"y":-1796.0770263671875,"z":28.378293991088867,"h":320.28326416015625},{"x":151.24176025390625,"y":-1744.63916015625,"z":28.635051727294922,"h":52.21820068359375},{"x":19.214492797851562,"y":-1684.413330078125,"z":28.82182502746582,"h":110.56121826171875},{"x":-85.97415924072266,"y":-1722.755615234375,"z":28.764490127563477,"h":110.75201416015625},{"x":-193.7579345703125,"y":-1785.603515625,"z":29.34210205078125,"h":120.503662109375},{"x":-278.6326599121094,"y":-1826.10107421875,"z":26.722946166992188,"h":98.38095092773438},{"x":-419.0188293457031,"y":-1844.848388671875,"z":19.641315460205078,"h":120.04681396484375},{"x":-536.0509033203125,"y":-1936.068603515625,"z":16.82436180114746,"h":132.5162353515625},{"x":-733.7822265625,"y":-2144.3388671875,"z":13.058256149291992,"h":138.20819091796875},{"x":-835.6460571289062,"y":-2234.491455078125,"z":17.01238441467285,"h":131.35504150390625},{"x":-1079.2132568359375,"y":-2598.714599609375,"z":19.637514114379883,"h":150.81170654296875},{"x":-873.34765625,"y":-2656.264404296875,"z":18.584218978881836,"h":330.3602294921875},{"x":-760.8343505859375,"y":-2454.803466796875,"z":13.837701797485352,"h":330.9873962402344},{"x":-751.4306030273438,"y":-2356.884765625,"z":14.38237476348877,"h":44.60247802734375},{"x":-1055.8800048828125,"y":-2053.769287109375,"z":12.69527816772461,"h":42.631744384765625},{"x":-1049.700439453125,"y":-1912.8948974609375,"z":12.554359436035156,"h":312.24212646484375},{"x":-891.6286010742188,"y":-1754.207275390625,"z":18.43243980407715,"h":317.7900695800781},{"x":-775.2499389648438,"y":-1621.519775390625,"z":14.207222938537598,"h":316.5755920410156},{"x":-690.2277221679688,"y":-1484.5469970703125,"z":10.508066177368164,"h":318.98162841796875},{"x":-646.954345703125,"y":-1423.4423828125,"z":10.153457641601562,"h":355.9153137207031},{"x":-637.8133544921875,"y":-1331.9056396484375,"z":10.147852897644043,"h":345.2146301269531},{"x":-639.60791015625,"y":-1276.3304443359375,"z":10.095355033874512,"h":42.226104736328125},{"x":-698.9639892578125,"y":-1205.3673095703125,"z":10.154378890991211,"h":39.1715087890625},{"x":-754.9605712890625,"y":-1132.5950927734375,"z":10.15291690826416,"h":27.468505859375},{"x":-764.9371337890625,"y":-1137.3414306640625,"z":10.15848445892334,"h":212.17034912109375},{"x":-721.1774291992188,"y":-1203.6444091796875,"z":10.087433815002441,"h":220.8531951904297},{"x":-716.4222412109375,"y":-1247.6685791015625,"z":9.023406028747559,"h":135.54803466796875},{"x":-743.7610473632812,"y":-1310.8988037109375,"z":4.496565818786621,"h":228.7469482421875}];
let checkPointsBoat:point[] = [{"x":-843.4854736328125,"y":-1525.5740966796875,"z":0.14268499612808228,"h":149.4349365234375},{"x":-910.327880859375,"y":-1590.6705322265625,"z":0.2897007167339325,"h":142.54510498046875},{"x":-945.2551879882812,"y":-1655.6744384765625,"z":0.42398345470428467,"h":148.66656494140625},{"x":-1069.0557861328125,"y":-1738.7752685546875,"z":0.7066565155982971,"h":133.9583740234375},{"x":-1138.7001953125,"y":-1840.8330078125,"z":0.5839182138442993,"h":133.80059814453125},{"x":-1273.7037353515625,"y":-1934.2825927734375,"z":0.48002395033836365,"h":131.02435302734375},{"x":-1347.0452880859375,"y":-1981.590576171875,"z":0.39958667755126953,"h":84.1041259765625},{"x":-1331.4422607421875,"y":-1941.0928955078125,"z":0.876524031162262,"h":317.1410827636719},{"x":-1297.8284912109375,"y":-1828.7623291015625,"z":0.3042279779911041,"h":26.982208251953125},{"x":-1488.599853515625,"y":-1530.3350830078125,"z":1.1708121299743652,"h":33.75445556640625},{"x":-1579.4810791015625,"y":-1374.201416015625,"z":0.540318489074707,"h":21.793609619140625},{"x":-1642.2646484375,"y":-1334.3758544921875,"z":0.12250995635986328,"h":88.20648193359375},{"x":-1787.58544921875,"y":-1242.0020751953125,"z":1.7767339944839478,"h":145.7451171875},{"x":-1860.76220703125,"y":-1251.474609375,"z":0.8389815092086792,"h":38.118316650390625},{"x":-1872.7811279296875,"y":-1190.86474609375,"z":0.06787723302841187,"h":302.6362609863281},{"x":-1819.4521484375,"y":-1144.7135009765625,"z":0.10543298721313477,"h":285.0888671875},{"x":-1909.3984375,"y":-1014.6152954101562,"z":0.22540009021759033,"h":83.5159912109375},{"x":-1963.3167724609375,"y":-1010.8145751953125,"z":0.728124737739563,"h":84.966064453125},{"x":-2056.3095703125,"y":-997.489013671875,"z":0.7308205962181091,"h":83.14068603515625},{"x":-2145.070068359375,"y":-1018.1329345703125,"z":1.0653363466262817,"h":220.34530639648438},{"x":-2048.479736328125,"y":-1083.657958984375,"z":0.4945491552352905,"h":240.57412719726562},{"x":-1905.312744140625,"y":-1217.4757080078125,"z":1.4702568054199219,"h":233.70278930664062},{"x":-1791.9149169921875,"y":-1315.755859375,"z":0.41349953413009644,"h":225.87460327148438},{"x":-1610.325439453125,"y":-1529.8668212890625,"z":0.7556361556053162,"h":212.25265502929688},{"x":-1407.2708740234375,"y":-1766.2147216796875,"z":0.707631528377533,"h":227.9028778076172},{"x":-1383.4404296875,"y":-1882.4132080078125,"z":0.49478545784950256,"h":160.4173583984375},{"x":-1292.3243408203125,"y":-1940.3057861328125,"z":1.5613842010498047,"h":271.4537353515625},{"x":-1079.470947265625,"y":-1824.29345703125,"z":0.4594196081161499,"h":300.7666320800781},{"x":-857.6038818359375,"y":-1646.7486572265625,"z":0.24289369583129883,"h":315.9606628417969},{"x":-658.09228515625,"y":-1519.93701171875,"z":0.370772123336792,"h":282.79644775390625},{"x":-404.38238525390625,"y":-1624.2164306640625,"z":0.5839635729789734,"h":223.41331481933594},{"x":5.129403591156006,"y":-1981.1763916015625,"z":0.23585781455039978,"h":231.17868041992188},{"x":59.980796813964844,"y":-2203.306396484375,"z":0.5828214287757874,"h":182.37872314453125},{"x":74.32376861572266,"y":-2271.56982421875,"z":0.44910043478012085,"h":230.08953857421875},{"x":91.84414672851562,"y":-2302.098388671875,"z":0.1356964111328125,"h":153.3046875},{"x":31.358816146850586,"y":-2299.589599609375,"z":0.2615305185317993,"h":5.3900146484375},{"x":49.35862731933594,"y":-2245.15234375,"z":1.007447600364685,"h":336.53192138671875},{"x":64.1595230102539,"y":-2084.87109375,"z":0.37403929233551025,"h":1.132293701171875},{"x":-32.22599792480469,"y":-1947.6419677734375,"z":0.26210033893585205,"h":50.1851806640625},{"x":-262.205322265625,"y":-1779.0849609375,"z":0.32993799448013306,"h":56.8291015625},{"x":-353.4410095214844,"y":-1691.70703125,"z":0.6339148879051208,"h":37.145263671875},{"x":-515.240478515625,"y":-1550.9334716796875,"z":0.28418678045272827,"h":60.285430908203125},{"x":-705.6392822265625,"y":-1539.8148193359375,"z":0.2484455108642578,"h":111.89794921875},{"x":-833.3319091796875,"y":-1623.6920166015625,"z":0.14159917831420898,"h":134.74014282226562},{"x":-969.6650390625,"y":-1752.978759765625,"z":0.4106626808643341,"h":130.94903564453125},{"x":-1036.0318603515625,"y":-1785.013427734375,"z":0.15810370445251465,"h":31.146209716796875},{"x":-1038.7412109375,"y":-1758.1181640625,"z":0.4534118175506592,"h":321.387451171875},{"x":-994.380126953125,"y":-1705.566162109375,"z":0.5613038539886475,"h":317.3875732421875},{"x":-861.7073974609375,"y":-1591.4722900390625,"z":0.3108821213245392,"h":311.67974853515625},{"x":-789.2890625,"y":-1494.1170654296875,"z":0.12122973799705505,"h":291.6692810058594}];
let checkPointsAir:point[] = [{"x":-1020.3011474609375,"y":-1714.4189453125,"z":68.43486785888672,"h":129.24566650390625},{"x":-1333.97900390625,"y":-1712.8111572265625,"z":129.5446014404297,"h":77.43316650390625},{"x":-2086.46044921875,"y":-1190.4715576171875,"z":112.83696746826172,"h":49.431610107421875},{"x":-2609.74609375,"y":-659.0928344726562,"z":131.489013671875,"h":45.40313720703125},{"x":-3068.503173828125,"y":-185.5432891845703,"z":163.61529541015625,"h":15.978790283203125},{"x":-3145.443603515625,"y":760.2889404296875,"z":182.3647918701172,"h":359.3790588378906},{"x":-2794.921630859375,"y":1334.16455078125,"z":194.7210235595703,"h":292.7320556640625},{"x":-2292.435302734375,"y":1522.615478515625,"z":324.81591796875,"h":288.28350830078125},{"x":-1856.1224365234375,"y":1312.503662109375,"z":409.8414611816406,"h":210.72532653808594},{"x":-1645.6126708984375,"y":424.9974365234375,"z":409.12030029296875,"h":199.3463592529297},{"x":-1335.18994140625,"y":-536.740966796875,"z":441.5110168457031,"h":206.50570678710938},{"x":-779.4417724609375,"y":-1246.5718994140625,"z":402.1397399902344,"h":253.79261779785156},{"x":-566.6782836914062,"y":-1494.886474609375,"z":227.82302856445312,"h":140.40606689453125},{"x":-674.5396728515625,"y":-1549.279052734375,"z":164.90036010742188,"h":51.26031494140625},{"x":-723.500732421875,"y":-1472.4066162109375,"z":4.9044084548950195,"h":229.59410095214844}];


let vehSpeedLimit = 100;
/** Предупреждения при автоматике */
let vehWarning = 3;
let checkSize = 5;
let end = true;
let vehid = 0;

let cdexitVeh = 30;




setTimeout(() => {
  mp.events.register("server:autoschool:practice", (type:string, vehicleid:number, auto = false) => {
    return new Promise(async (resolve:(status:boolean)=>void) => {
      vehid = vehicleid;
      let player = mp.players.local;
      let checkpoints:point[] = [];
      let check:CheckpointMp;
      let blip:BlipMp;
      let currentCheckID = 0;
      let checkBlip = 2;
      let checkBlipFinish = 4;
      vehWarning = 3;
      mp.game.ui.notifications.show("Приступайте к выполнению");
      mp.game.ui.notifications.show("Не забудьте пристегнутся [X]");
      if(type.length == 1){
        checkpoints = checkPointsVeh;
        // const speedCheck = () => {
        //   if(player.vehicle){
        //     if(type.length == 1 && methods.getCurrentSpeed() > 10 && !seatBelt && auto){
        //       vehWarning--;
        //       mp.game.ui.notifications.show("Нарушение\nДвижение без пристёгнутого ремня безопасности ("+(3-vehWarning)+"/3)");
        //     }
        //   }
        //   if(vehWarning <= 0) end = true, resolve(false);
        //   setTimeout(() => {
        //     if(!end) speedCheck()
        //   }, 5000)
        // }
        // if(auto) speedCheck();
      } else if(type == "ship"){
        checkpoints = checkPointsBoat;
      } else if(type == "air"){
        checkpoints = checkPointsAir;
      }
      end = false;
      let interval = setInterval(() => {
        if(end){
          cdexitVeh = 30
          clearInterval(interval)
        } else if(mp.players.local.vehicle && mp.players.local.vehicle.remoteId == vehid){
          cdexitVeh = 30;
        } else {
          cdexitVeh--
          mp.game.ui.notifications.show("Вернитесь в учебный ТС ("+(cdexitVeh+1)+")");
          if(cdexitVeh == 0){
            resolve(false)
            end = true;
            clearInterval(interval);
          }
        }
      }, 1000)
      while(!end){
        let checkdata = {
          x: methods.parseFloat(checkpoints[currentCheckID].x),
          y: methods.parseFloat(checkpoints[currentCheckID].y),
          z: methods.parseFloat(checkpoints[currentCheckID].z),
        }
        let checkdataNext = {
          x: methods.parseFloat(checkpoints[currentCheckID].x),
          y: methods.parseFloat(checkpoints[currentCheckID].y),
          z: methods.parseFloat(checkpoints[currentCheckID].z),
        }
        if(currentCheckID != (checkpoints.length - 1)){
          checkdataNext = {
            x: methods.parseFloat(checkpoints[currentCheckID + 1].x),
            y: methods.parseFloat(checkpoints[currentCheckID + 1].y),
            z: methods.parseFloat(checkpoints[currentCheckID + 1].z),
          }
        }
        check = mp.checkpoints.new(currentCheckID == (checkpoints.length - 1) ? checkBlipFinish : checkBlip, new mp.Vector3(checkdata.x, checkdata.y, checkdata.z-1), checkSize + 0.0001, {
          direction: (currentCheckID == (checkpoints.length - 1)) ? new mp.Vector3(0, 0, 75) : new mp.Vector3(checkdataNext.x, checkdataNext.y, checkdataNext.z),
          color: [255, 255, 0, 60],
          visible: true,
          dimension: player.dimension
        });
        blip = mp.blips.new((currentCheckID == (checkpoints.length - 1)) ? 611 : 1, new mp.Vector3(checkdata.x, checkdata.y, checkdata.z), {
          name: (!checkdataNext) ? 'Финишная точка' : 'Контрольная точка',
          color: 5,
          shortRange: false,
          dimension: player.dimension
        });
        blip.setRoute(true);

        let reached = false;
    
        while (!reached) {
          let distance = mp.game.gameplay.getDistanceBetweenCoords(checkdata.x, checkdata.y, checkdata.z, player.position.x, player.position.y, player.position.z, false);
          if (distance < (checkSize+0.8)) {
            if(player.vehicle && player.vehicle.remoteId == vehicleid){
              reached = true;
              mp.game.audio.playSound(-1, "SELECT", "HUD_FRONTEND_DEFAULT_SOUNDSET", false, 0, true);
            } else {
              await wait(10)
            }
          } else {
            await wait(10)
          }
          if(end){
            if(blip)blip.destroy(),blip=null;
            if(check)check.destroy(),check=null;
            reached = true;
          }
        }
        if(blip)blip.destroy(),blip=null;
        if(check)check.destroy(),check=null;
        if(currentCheckID == (checkpoints.length - 1)){
          end = true
          resolve(true);
        } else {
          currentCheckID++;
        }
      }

    })
  })
}, 100)